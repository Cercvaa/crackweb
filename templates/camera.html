{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">Take a Photo</h5>
    <div class="row g-4">
      <div class="col-12 col-md-6">
        <div class="ratio ratio-4x3 bg-light rounded d-flex align-items-center justify-content-center">
          <video id="video" autoplay playsinline muted class="w-100 h-100" style="object-fit: cover; border-radius: .75rem;"></video>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="btn-start" class="btn btn-secondary">Start Camera</button>
          <button id="btn-capture" class="btn btn-primary" disabled>Capture</button>
          <button id="btn-switch" class="btn btn-outline-secondary d-none">Switch Camera</button>
        </div>
        <small class="text-muted d-block mt-2">
          Tip: On phones, this tries the rear camera by default.
        </small>
      </div>
      <div class="col-12 col-md-6">
        <h6 class="mb-2">Preview</h6>
        <div class="ratio ratio-4x3 bg-light rounded">
          <canvas id="canvas" class="w-100 h-100" style="border-radius: .75rem;"></canvas>
        </div>
        <form id="form" action="/predict" method="post" enctype="multipart/form-data" class="mt-3">
          <input type="file" id="hidden-file" name="file" class="d-none">
          <button id="btn-submit" class="btn btn-success" disabled>Analyze Captured Photo</button>
          <a class="btn btn-outline-secondary ms-2" href="/">Upload instead</a>
        </form>
        <div id="msg" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const startBtn = document.getElementById('btn-start');
  const snapBtn = document.getElementById('btn-capture');
  const submitBtn = document.getElementById('btn-submit');
  const switchBtn = document.getElementById('btn-switch');
  const msg = document.getElementById('msg');
  let stream = null;
  let currentFacing = 'environment';

  const constraints = (facing) => ({
    audio: false,
    video: { facingMode: { ideal: facing }, width: { ideal: 1280 }, height: { ideal: 720 } }
  });

  async function startCamera(facing='environment') {
    try {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia(constraints(facing));
      video.srcObject = stream;
      snapBtn.disabled = false;
      switchBtn.classList.remove('d-none');
      msg.textContent = '';
    } catch (e) {
      msg.textContent = 'Camera access failed: ' + e.message;
    }
  }

  startBtn.addEventListener('click', () => startCamera(currentFacing));

  switchBtn.addEventListener('click', async () => {
    currentFacing = (currentFacing === 'environment') ? 'user' : 'environment';
    await startCamera(currentFacing);
  });

  snapBtn.addEventListener('click', () => {
    if (!stream) return;
    const vw = video.videoWidth, vh = video.videoHeight;
    if (vw === 0 || vh === 0) { msg.textContent = 'Camera not ready. Try again.'; return; }
    canvas.width = vw; canvas.height = vh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, vw, vh);
    submitBtn.disabled = false;
    msg.textContent = '';
  });

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    canvas.toBlob(async (blob) => {
      if (!blob) { msg.textContent = 'Could not capture image.'; submitBtn.disabled = false; return; }
      const file = new File([blob], 'camera.jpg', { type: 'image/jpeg' });
      const fd = new FormData();
      fd.append('file', file);
      try {
        const res = await fetch('/predict', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Server error ' + res.status);
        const html = await res.text();
        document.open(); document.write(html); document.close();
      } catch (err) {
        msg.textContent = 'Upload failed: ' + err.message;
        submitBtn.disabled = false;
      }
    }, 'image/jpeg', 0.95);
  });
})();
</script>
{% endblock %}
